<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Info QR Generator & Scanner</title>

  <!-- Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- HTML5 QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <style>
    :root { --brand-red: #B71C1C; }
    body {
      background: #EEEEEE;
      padding: 0; /* remove outer gaps so header/footer touch edges */
      margin: 0;  /* ensure no default body margin on any device */
      display: flex;
      min-height: 100vh;
      flex-direction: column;
      font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
    }
    /* App content container centering */
    .app-container {
      max-width: 1140px;
      margin: 24px auto;
      padding-left: 16px;
      padding-right: 16px;
    }

    /* Match primary color to header/footer red */
    .text-primary { color: var(--brand-red) !important; }
    .btn-primary {
      background-color: var(--brand-red);
      border-color: var(--brand-red);
      color: #fff;
    }
    /* Invert on hover/focus/active: white background, red text/border */
    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active,
    .btn-primary:focus-visible,
    .btn-primary:active:focus,
    .show > .btn-primary.dropdown-toggle {
      background-color: #ffffff;
      border-color: var(--brand-red);
      color: var(--brand-red);
    }
    /* Red focus ring instead of blue */
    .btn-primary:focus,
    .btn-primary:focus-visible,
    .btn-primary:active:focus {
      box-shadow: 0 0 0 0.2rem rgba(183, 28, 28, 0.25);
      outline: none;
    }
    /* Keep disabled state consistent */
    .btn-primary:disabled,
    .btn-primary.disabled {
      background-color: var(--brand-red);
      border-color: var(--brand-red);
      color: #fff;
    }

    /* Inverted white/red button style */
    .btn-invert-primary {
      background-color: #ffffff;
      color: var(--brand-red);
      border: 1px solid var(--brand-red);
    }
    .btn-invert-primary:hover,
    .btn-invert-primary:focus,
    .btn-invert-primary:active {
      background-color: var(--brand-red);
      color: #ffffff;
      border-color: var(--brand-red);
      box-shadow: 0 0 0 0.2rem rgba(183, 28, 28, 0.25);
    }

    /* Brand alert (red background, white text) for scan output */
    .alert-brand {
      background-color: var(--brand-red);
      color: #ffffff;
      border: 1px solid var(--brand-red);
    }
    .card {
      border-radius: 16px;
      border: 1px solid var(--brand-red);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    #qr-reader {
      width: 100%;
      max-width: 100%;
    }
    .qr-wrapper { position: relative; }
    /* Modal-like overlay inside camera on successful camera scan */
    .camera-modal {
      position: absolute;
      inset: 0;
      background: rgba(40, 167, 69, 0.9); /* green overlay */
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-radius: 12px;
    }
    .camera-modal .icon {
      width: 92px;
      height: 92px;
      border-radius: 50%;
      border: 4px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      margin: 0 auto 10px;
      font-weight: 700;
    }
    .camera-modal .label { font-weight: 600; letter-spacing: 0.5px; }
    #qr-reader video,
    #qr-reader canvas,
    #qr-reader img,
    #qr-reader div {
      max-width: 100% !important;
    }
    #qrImage {
      max-width: 100%;
    }
    canvas {
      display: none;
    }
    /* Fade-out animation */
    .fade-out {
      opacity: 0;
      transition: opacity 1s ease-out;
    }
    /* Layout helpers */
    main {
      flex: 1 0 auto;
    }
    footer.site-footer {
      background: var(--brand-red); /* unified red */
      color: #fff;
      margin: 0;           /* no gaps */
      border: 0;
      box-shadow: none;
      padding: 12px 0;
    }
    footer.site-footer a {
      color: #adb5bd;
      text-decoration: none;
    }
    footer.site-footer a:hover {
      color: #fff;
    }

    /* Remove container horizontal padding inside footer */
    footer.site-footer .container,
    footer.site-footer .container-fluid {
      padding-left: 0;
      padding-right: 0;
    }

    /* SweetAlert2 Custom Styling */
    .swal2-popup {
      font-family: 'Poppins', sans-serif !important;
      border-radius: 16px !important;
    }
    
    .swal2-title {
      color: var(--brand-red) !important;
      font-weight: 600 !important;
    }
    
    .swal2-confirm {
      background-color: var(--brand-red) !important;
      border-color: var(--brand-red) !important;
    }
    
    .swal2-confirm:hover {
      background-color: #8E1414 !important;
      border-color: #8E1414 !important;
    }
    
    /* Mobile SweetAlert2 Enhancements */
    @media (max-width: 768px) {
      .swal2-popup {
        margin: 10px !important;
        border-radius: 12px !important;
        max-width: calc(100vw - 20px) !important;
        width: calc(100vw - 20px) !important;
      }
      
      .swal2-title {
        font-size: 1.1rem !important;
        margin-bottom: 15px !important;
      }
      
      .swal2-html-container {
        font-size: 0.9rem !important;
        margin: 10px 0 !important;
      }
      
      .swal2-confirm {
        font-size: 0.9rem !important;
        padding: 8px 20px !important;
        border-radius: 8px !important;
      }
    }
    
    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .swal2-popup {
        margin: 5px !important;
        max-width: calc(100vw - 10px) !important;
        width: calc(100vw - 10px) !important;
      }
      
      .swal2-title {
        font-size: 1rem !important;
      }
      
      .swal2-html-container {
        font-size: 0.85rem !important;
      }
    }

    /* Desktop / Website-only SweetAlert2 width override */
    @media (min-width: 992px) {
      .swal2-popup {
        max-width: 800px !important; /* wider popup for desktop */
        width: 700px !important;     /* preferred width */
        padding: 1.75rem !important;
      }

      .swal2-title {
        font-size: 1.25rem !important;
      }

      .swal2-html-container {
        font-size: 1rem !important;
      }
    }

    /* Mobile responsiveness */
    @media (max-width: 576px) {
      body { padding: 0; margin: 0; }
      h2 { font-size: 1.25rem; }
      .card { border-radius: 14px; }
      .card.p-4 { padding: 1rem !important; }
      #qr-reader { min-height: 240px; }
      label { font-size: 0.9rem; }
      input, button { font-size: 1rem; }
      /* Stack form columns on mobile */
      .col-md-6 { margin-bottom: 0.5rem; }
    }
    
    /* Tablet responsiveness */
    @media (max-width: 768px) {
      .col-md-6 { margin-bottom: 0.75rem; }
    }

    /* Brand scrollbar styling */
    /* Firefox */
    html {
      scrollbar-color: var(--brand-red) #e9ecef;
      scrollbar-width: thin;
    }
    /* WebKit (Chrome, Edge, Safari) */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #e9ecef; }
    ::-webkit-scrollbar-thumb {
      background-color: var(--brand-red);
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    ::-webkit-scrollbar-thumb:hover { background-color: #8E1414; }
  </style>
</head>
<body>
  <main>
  <div class="container app-container">
    <h2 class="text-center fw-bold mb-4 text-primary">Student Info QR Generator &amp; Scanner</h2>
    <div class="row">
      
      <!-- QR Generator -->
      <div id="generate" class="col-md-6 mb-4">
        <div class="card p-4 shadow-sm">
          <h4 class="text-primary mb-3">Generate Student QR</h4>
          <form id="qrForm">
            <div class="row">
              <!-- Left Column -->
              <div class="col-md-6">
                <div class="mb-2">
                  <label>Student ID</label>
                  <input type="text" id="studentId" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Full Name</label>
                  <input type="text" id="fullName" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>EVSU Email</label>
                  <input type="email" id="email" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Age</label>
                  <input type="number" id="age" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Birthdate</label>
                  <input type="date" id="birthdate" class="form-control" required>
                </div>
              </div>
              
              <!-- Right Column -->
              <div class="col-md-6">
                <div class="mb-2">
                  <label>Gender</label>
                  <select id="gender" class="form-control" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label>Nationality</label>
                  <input type="text" id="nationality" class="form-control" list="nationalityOptions" required>
                  <datalist id="nationalityOptions">
                    <option value="Afghan">
                    <option value="Albanian">
                    <option value="Algerian">
                    <option value="American">
                    <option value="Argentine">
                    <option value="Armenian">
                    <option value="Australian">
                    <option value="Austrian">
                    <option value="Bangladeshi">
                    <option value="Belgian">
                    <option value="Brazilian">
                    <option value="British">
                    <option value="Bulgarian">
                    <option value="Cambodian">
                    <option value="Canadian">
                    <option value="Chilean">
                    <option value="Chinese">
                    <option value="Colombian">
                    <option value="Croatian">
                    <option value="Cuban">
                    <option value="Czech">
                    <option value="Danish">
                    <option value="Dutch">
                    <option value="Egyptian">
                    <option value="Filipino">
                    <option value="Finnish">
                    <option value="French">
                    <option value="German">
                    <option value="Greek">
                    <option value="Hungarian">
                    <option value="Indian">
                    <option value="Indonesian">
                    <option value="Iranian">
                    <option value="Iraqi">
                    <option value="Irish">
                    <option value="Israeli">
                    <option value="Italian">
                    <option value="Japanese">
                    <option value="Jordanian">
                    <option value="Korean">
                    <option value="Kuwaiti">
                    <option value="Lebanese">
                    <option value="Malaysian">
                    <option value="Mexican">
                    <option value="Moroccan">
                    <option value="Nepalese">
                    <option value="Norwegian">
                    <option value="Pakistani">
                    <option value="Peruvian">
                    <option value="Polish">
                    <option value="Portuguese">
                    <option value="Romanian">
                    <option value="Russian">
                    <option value="Saudi">
                    <option value="Singaporean">
                    <option value="South African">
                    <option value="Spanish">
                    <option value="Sri Lankan">
                    <option value="Swedish">
                    <option value="Swiss">
                    <option value="Thai">
                    <option value="Turkish">
                    <option value="Ukrainian">
                    <option value="Venezuelan">
                    <option value="Vietnamese">
                  </datalist>
                </div>
                <div class="mb-2">
                  <label>Birthplace</label>
                  <input type="text" id="birthplace" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Contact Number</label>
                  <input type="text" id="contact" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Address</label>
                  <input type="text" id="address" class="form-control" required>
                </div>
              </div>
            </div>
            
            <!-- Full Width Button -->
            <div class="mb-3 mt-3">
              <button type="button" class="btn btn-primary w-100" onclick="generateQR()">Generate QR Code</button>
            </div>
          </form>

          <div class="text-center mt-3">
            <img id="qrImage" class="img-fluid rounded" alt="">
            <a id="downloadQR" class="btn btn-invert-primary mt-2 d-none" download="student_qr.png">Download QR</a>
          </div>
        </div>
      </div>

      <!-- QR Scanner -->
      <div id="scan" class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h4 class="text-primary mb-3">Scan Student QR</h4>
          <div class="qr-wrapper mb-3">
            <div id="qr-reader"></div>
            <div id="cameraModal" class="camera-modal d-none">
              <div>
                <div class="icon">✓</div>
                <div class="label">Camera Scan Successful</div>
              </div>
            </div>
          </div>
          
          <!-- NEW: Choose File Option -->
          <div class="mb-3 text-center">
            <label for="qrFile" class="form-label fw-bold">Or choose QR image from your device:</label>
            <input type="file" id="qrFile" accept="image/*" class="form-control" onchange="scanFromFile(event)">
          </div>

          <canvas id="qrCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
  </main>

  <footer class="site-footer">
    <div class="container-fluid text-center">
      <small>&copy; I LOVE YOU LANGGING  | JANILYN</small>
    </div>
  </footer>


  <script>
    // Generate and download QR
    function generateQR() {
      const data = {
        studentId: document.getElementById("studentId").value,
        fullName: document.getElementById("fullName").value,
        email: document.getElementById("email").value,
        age: document.getElementById("age").value,
        birthdate: document.getElementById("birthdate").value,
        address: document.getElementById("address").value,
        contact: document.getElementById("contact").value,
        gender: document.getElementById("gender").value,
        nationality: document.getElementById("nationality").value,
        birthplace: document.getElementById("birthplace").value,
      };

      // Prevent empty submission
      if (!data.studentId || !data.fullName || !data.email) {
        alert("Please fill in all required fields!");
        return;
      }

      const qrData = JSON.stringify(data);
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
      const qrImage = document.getElementById("qrImage");
      const downloadLink = document.getElementById("downloadQR");

      qrImage.src = qrUrl;
      qrImage.onload = () => {
        fetch(qrUrl)
          .then(res => res.blob())
          .then(blob => {
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = `${data.studentId}_qr.png`;
            downloadLink.classList.remove("d-none");
          });
      };

      // ✅ Clear form fields after generation
      document.getElementById("qrForm").reset();
    }

    // Initialize camera scanner
    const cameraModal = document.getElementById('cameraModal');
    
    function onScanSuccess(decodedText) {
      try {
        const info = JSON.parse(decodedText);
        
        // Create HTML content for SweetAlert with responsive design
        const isMobile = window.innerWidth <= 768;
        const studentInfoHtml = `
          <div style="text-align: left; font-family: 'Poppins', sans-serif;">
            <div style="display: ${isMobile ? 'block' : 'grid'}; ${isMobile ? '' : 'grid-template-columns: 1fr 1fr;'} gap: ${isMobile ? '10px' : '15px'}; margin-top: ${isMobile ? '15px' : '20px'};">
              <div style="${isMobile ? 'margin-bottom: 15px;' : ''}">
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Student ID:</strong>${info.studentId}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Full Name:</strong>${info.fullName}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Email:</strong>${info.email}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Age:</strong>${info.age}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Birthdate:</strong>${info.birthdate}</p>
              </div>
              <div>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Gender:</strong>${info.gender}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Nationality:</strong>${info.nationality}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Birthplace:</strong>${info.birthplace}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Contact:</strong>${info.contact}</p>
                <p style="margin: ${isMobile ? '6px 0' : '8px 0'}; font-size: ${isMobile ? '0.9rem' : '1rem'};"><strong style="color: var(--brand-red); display: block; margin-bottom: 2px;">Address:</strong>${info.address}</p>
              </div>
            </div>
          </div>
        `;
        
        // Show SweetAlert2 with enhanced mobile responsiveness
        Swal.fire({
          title: '<i class="fas fa-check-circle" style="color: #28a745;"></i> QR Scan Successful!',
          html: studentInfoHtml,
          icon: 'success',
          confirmButtonText: 'Close',
          confirmButtonColor: 'var(--brand-red)',
          width: isMobile ? '95%' : '600px',
          padding: isMobile ? '1rem' : '1.5rem',
          showConfirmButton: true,
          allowOutsideClick: true,
          allowEscapeKey: true,
          backdrop: true,
          customClass: {
            popup: 'swal2-popup-custom',
            title: 'swal2-title-custom',
            htmlContainer: 'swal2-html-container-custom'
          }
        });
        
        // Show green modal overlay ONLY for camera scans
        if (!window._lastScanWasFile) {
          cameraModal.classList.remove('d-none');
          setTimeout(() => cameraModal.classList.add('d-none'), 1500);
        }
      } catch {
        // Show error SweetAlert
        Swal.fire({
          title: '<i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Invalid QR Code',
          text: 'Please scan a valid student QR code.',
          icon: 'error',
          confirmButtonText: 'Try Again',
          confirmButtonColor: 'var(--brand-red)'
        });
      }
    }

    const html5QrCode = new Html5Qrcode("qr-reader");
    let isScannerRunning = false;

    function computeQrBox() {
      const container = document.getElementById('qr-reader');
      const containerWidth = container ? container.clientWidth : window.innerWidth;
      const size = Math.max(180, Math.min(320, Math.floor(containerWidth * 0.8)));
      return { width: size, height: size };
    }

    async function startScanner() {
      const config = { fps: 10, qrbox: computeQrBox() };
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          await html5QrCode.start({ facingMode: 'environment' }, config, onScanSuccess);
          isScannerRunning = true;
        }
      } catch (err) {
        console.error('Camera error:', err);
      }
    }

    async function restartScannerOnResize() {
      if (!isScannerRunning) return;
      try {
        await html5QrCode.stop();
        isScannerRunning = false;
        await startScanner();
      } catch (err) {
        console.error('Restart error:', err);
      }
    }

    let _resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(_resizeTimer);
      _resizeTimer = setTimeout(restartScannerOnResize, 200);
    });

    startScanner();

    // Scan from uploaded file
    function scanFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      // mark that this scan is from file so we don't show camera check
      window._lastScanWasFile = true;

      const reader = new FileReader();
      reader.onload = function() {
        const img = new Image();
        img.onload = function() {
          const canvas = document.getElementById("qrCanvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code) {
            onScanSuccess(code.data);
            // reset flag shortly after processing file
            setTimeout(() => { window._lastScanWasFile = false; }, 500);
          } else {
            // Show warning SweetAlert
            Swal.fire({
              title: '<i class="fas fa-search" style="color: #ffc107;"></i> No QR Code Found',
              text: 'No QR code detected in the uploaded image. Please try with a different image or ensure the QR code is clearly visible.',
              icon: 'warning',
              confirmButtonText: 'Try Again',
              confirmButtonColor: 'var(--brand-red)'
            });
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
